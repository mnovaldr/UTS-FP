{% extends 'perpustakaan/base.html' %}

{% block title %}Daftar Peminjaman - Perpustakaan{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
        <h1>ðŸ“‹ Daftar Peminjaman</h1>
        <a href="{% url 'peminjaman-tambah' %}" class="btn btn-success">+ Peminjaman Baru</a>
    </div>

    <!-- Filter & Search Controls -->
    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
        <input type="text" id="search-input" placeholder="Cari nama peminjam atau judul buku..." 
               style="flex: 1; padding: 0.5rem; border: 1px solid #cbd5e0; border-radius: 4px; min-width: 200px;">
        
        <select id="filter-status" style="padding: 0.5rem; border: 1px solid #cbd5e0; border-radius: 4px;">
            <option value="">Semua Status</option>
            <option value="DIPINJAM">Dipinjam</option>
            <option value="DIKEMBALIKAN">Dikembalikan</option>
            <option value="TERLAMBAT">Terlambat</option>
        </select>
        
        <button id="btn-cari" class="btn btn-primary">Cari</button>
    </div>

    <div id="data-container">
        <table class="table" id="peminjaman-table">
            <thead>
                <tr>
                    <th>Peminjam</th>
                    <th>Buku</th>
                    <th>Tanggal Pinjam</th>
                    <th>Tanggal Kembali</th>
                    <th>Status</th>
                    <th>Denda</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="peminjaman-tbody">
                <!-- Data akan dimuat via API -->
            </tbody>
        </table>

        <!-- Pagination Controls -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem;">
            <button id="prev-btn" class="btn btn-primary" style="opacity: 0.5; cursor: not-allowed;" disabled>Previous</button>
            <span id="page-info" style="color: #4a5568;">Halaman 1</span>
            <button id="next-btn" class="btn btn-primary" style="opacity: 0.5; cursor: not-allowed;" disabled>Next</button>
        </div>

        <!-- Statistik -->
        <div class="stat-cards">
            <div class="stat-card" style="background: #e8f4fd;">
                <h3 id="stat-total">0</h3>
                <p>Total Peminjaman</p>
            </div>
            <div class="stat-card" style="background: #fff3cd;">
                <h3 id="stat-dipinjam">0</h3>
                <p>Sedang Dipinjam</p>
            </div>
            <div class="stat-card" style="background: #d4edda;">
                <h3 id="stat-dikembalikan">0</h3>
                <p>Telah Dikembalikan</p>
            </div>
            <div class="stat-card" style="background: #f8d7da;">
                <h3 id="stat-terlambat">0</h3>
                <p>Terlambat</p>
            </div>
        </div>
    </div>

    <div id="empty-state" style="display: none; text-align: center; padding: 3rem; color: #718096;">
        <p style="font-size: 1.2rem; margin-bottom: 1.5rem;">Belum ada data peminjaman.</p>
        <a href="{% url 'peminjaman-tambah' %}" class="btn btn-success">Buat Peminjaman Pertama</a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    loadData();

    document.getElementById('btn-cari').addEventListener('click', () => loadData(1));
    document.getElementById('search-input').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') loadData(1);
    });
    document.getElementById('filter-status').addEventListener('change', () => loadData(1));
    document.getElementById('prev-btn').addEventListener('click', () => {
        if (currentPage > 1) loadData(currentPage - 1);
    });
    document.getElementById('next-btn').addEventListener('click', () => {
        loadData(currentPage + 1);
    });

    function loadData(page = 1) {
        const search = document.getElementById('search-input').value;
        const status = document.getElementById('filter-status').value;
        
        const params = { page: page, ordering: '-tanggal_pinjam' };
        if (search) params.search = search;
        if (status) params.status = status;

        window.apiClient.get('peminjaman', params).then(res => {
            // Handle Pagination
            const data = res.results || res;

            const tbody = document.getElementById('peminjaman-tbody');
            const tableContainer = document.getElementById('data-container');
            const emptyState = document.getElementById('empty-state');

            // Cek jika data kosong
            if (!data || data.length === 0) {
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            tableContainer.style.display = 'block';
            emptyState.style.display = 'none';
            tbody.innerHTML = '';

            // Inisialisasi counter
            let countDipinjam = 0;
            let countDikembalikan = 0;
            let countTerlambat = 0;

            data.forEach(pinjam => {
                const tr = document.createElement('tr');
                
                // Format Tanggal (menggantikan filter |date Django)
                const options = { day: 'numeric', month: 'short', year: 'numeric' };
                const tglPinjam = new Date(pinjam.tanggal_pinjam).toLocaleDateString('id-ID', options);
                const tglKembali = pinjam.tanggal_kembali ? new Date(pinjam.tanggal_kembali).toLocaleDateString('id-ID', options) : '-';

                // Logika Status Badge
                let statusBadge = '';
                // Menggunakan status_display dari serializer untuk teks, dan status raw untuk logika warna
                const statusLabel = pinjam.status_display || pinjam.status;

                if (pinjam.status === 'DIKEMBALIKAN') {
                    statusBadge = `<span class="status-badge" style="background: #d4edda; color: #155724;">${statusLabel}</span>`;
                    countDikembalikan++;
                } else if (pinjam.status === 'TERLAMBAT') {
                    statusBadge = `<span class="status-badge" style="background: #f8d7da; color: #721c24;">${statusLabel}</span>`;
                    countTerlambat++;
                } else {
                    statusBadge = `<span class="status-badge" style="background: #fff3cd; color: #856404;">${statusLabel}</span>`;
                    countDipinjam++;
                }

                // Logika Denda
                let dendaHtml = `Rp${pinjam.denda}`;
                if (pinjam.denda > 0) {
                    dendaHtml = `<span style="color: #e74c3c; font-weight: 500;">Rp${pinjam.denda}</span>`;
                }

                // Handle Data Nested (Anggota & Buku)
                // Catatan: Pastikan Serializer di backend mengembalikan object detail (depth=1) 
                // atau field khusus, bukan hanya ID.
                const namaAnggota = pinjam.anggota.nama_lengkap || pinjam.anggota_nama || `Anggota #${pinjam.anggota}`;
                const judulBuku = pinjam.buku.judul || pinjam.buku_judul || `Buku #${pinjam.buku}`;
                // Asumsi ID tersedia di properti .id atau langsung jika integer
                const anggotaId = pinjam.anggota.id || pinjam.anggota;
                const bukuId = pinjam.buku.id || pinjam.buku;

                tr.innerHTML = `
                    <td>
                        <a href="/perpustakaan/anggota/${anggotaId}/">${namaAnggota}</a>
                    </td>
                    <td>
                        <a href="/perpustakaan/buku/${bukuId}/">${judulBuku}</a>
                    </td>
                    <td>${tglPinjam}</td>
                    <td>${tglKembali}</td>
                    <td>${statusBadge}</td>
                    <td>${dendaHtml}</td>
                    <td>
                        <a href="/perpustakaan/peminjaman/${pinjam.id}/" class="btn btn-primary">Detail</a>
                        <a href="/perpustakaan/peminjaman/${pinjam.id}/edit/" class="btn btn-warning">Edit</a>
                        <a href="/perpustakaan/peminjaman/${pinjam.id}/delete/" class="btn btn-danger">Hapus</a>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Update Statistik (Note: Ini hanya statistik halaman aktif karena pagination)
            // Untuk statistik akurat seluruh database, perlu endpoint khusus.
            document.getElementById('stat-total').textContent = res.count;
            document.getElementById('stat-dipinjam').textContent = countDipinjam + (res.next ? '+' : '');
            document.getElementById('stat-dikembalikan').textContent = countDikembalikan + (res.next ? '+' : '');
            document.getElementById('stat-terlambat').textContent = countTerlambat + (res.next ? '+' : '');

            // Pagination UI
            if (res.next) currentPage = new URLSearchParams(res.next.split('?')[1]).get('page') - 1;
            else if (res.previous && !res.next) currentPage = Math.ceil(res.count / 10);
            else currentPage = 1;

            document.getElementById('page-info').textContent = `Halaman ${currentPage} (Total: ${res.count})`;
            
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            prevBtn.disabled = !res.previous;
            prevBtn.style.opacity = res.previous ? '1' : '0.5';
            nextBtn.disabled = !res.next;
            nextBtn.style.opacity = res.next ? '1' : '0.5';
        });
    }
});
</script>
{% endblock %}